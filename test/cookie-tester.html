<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CookieGuard Testing Suite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #1a1a1a;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: #1a1a1a;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab-btn.active {
      color: #6B5B4B;
      border-bottom-color: #6B5B4B;
    }

    .tab-content {
      display: none;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab-content.active {
      display: block;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #1a1a1a;
    }

    .section h3 {
      font-size: 14px;
      margin: 16px 0 8px 0;
      color: #666;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: #6B5B4B;
      color: white;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #e0e0e0;
    }

    .btn-success {
      background: #7bed9f;
      color: #1a1a1a;
    }

    .btn-danger {
      background: #ff4757;
      color: white;
    }

    .btn:hover {
      opacity: 0.8;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .file-input {
      margin-bottom: 10px;
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 10px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .result-box {
      background: #f8f9fa;
      border-left: 4px solid #6B5B4B;
      padding: 16px;
      margin: 10px 0;
      border-radius: 4px;
    }

    .success-box {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }

    .error-box {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }

    .warning-box {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }

    .stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #1a1a1a;
    }

    .cookie-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }

    .cookie-table th,
    .cookie-table td {
      padding: 10px;
      border: 1px solid #e0e0e0;
      text-align: left;
    }

    .cookie-table th {
      background: #f8f9fa;
      font-weight: 600;
    }

    .cookie-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }

    .badge-critical { background: #ff4757; color: white; }
    .badge-high { background: #ffa502; color: white; }
    .badge-medium { background: #ffdd59; color: #1a1a1a; }
    .badge-low { background: #7bed9f; color: #1a1a1a; }
    .badge-added { background: #28a745; color: white; }
    .badge-removed { background: #dc3545; color: white; }
    .badge-modified { background: #ffc107; color: #1a1a1a; }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .input-group {
      flex: 1;
      min-width: 200px;
    }

    .input-group label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .diff-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .diff-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
    }

    .diff-section h3 {
      margin-top: 0;
    }

    .cookie-item {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border-left: 3px solid #6B5B4B;
      font-size: 12px;
    }

    .cookie-item.added {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .cookie-item.removed {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .cookie-item.modified {
      border-left-color: #ffc107;
      background: #fff3cd;
    }

    .collapse-btn {
      background: none;
      border: none;
      color: #6B5B4B;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      margin-left: 10px;
    }

    .collapsible-content {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }

    .hidden {
      display: none;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üç™ CookieGuard Testing Suite</h1>
    <p class="subtitle">Test export functionality and login model detection</p>

    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab(0)">Export Testing</button>
      <button class="tab-btn" onclick="switchTab(1)">Login Model Testing</button>
      <button class="tab-btn" onclick="switchTab(2)">Generate Test Data</button>
      <button class="tab-btn" onclick="switchTab(3)">Backend Testing</button>
    </div>

    <!-- Tab 1: Export Testing -->
    <div class="tab-content active" id="tab-0">
      <div class="section">
        <h2>Test Cookie Export</h2>
        <p style="color: #666; margin-bottom: 15px;">
          Upload an exported cookie JSON file from the extension to validate format and analyze contents.
        </p>

        <div class="file-input">
          <input type="file" id="export-file" accept=".json" class="btn btn-secondary">
        </div>

        <div id="export-results"></div>
      </div>
    </div>

    <!-- Tab 2: Login Model Testing -->
    <div class="tab-content" id="tab-1">
      <div class="section">
        <h2>Test Login Detection Model</h2>
        <p style="color: #666; margin-bottom: 15px;">
          Upload before/after cookie snapshots to test the login detection algorithm.
        </p>

        <div class="controls">
          <div class="input-group">
            <label>Before Login Cookies:</label>
            <input type="file" id="before-file" accept=".json" class="btn btn-secondary">
          </div>
          <div class="input-group">
            <label>After Login Cookies:</label>
            <input type="file" id="after-file" accept=".json" class="btn btn-secondary">
          </div>
        </div>

        <button class="btn btn-primary" onclick="analyzeLoginDiff()">Analyze Login Changes</button>
        <button class="btn btn-secondary" onclick="clearLoginTest()">Clear</button>

        <div id="login-results"></div>
      </div>
    </div>

    <!-- Tab 3: Generate Test Data -->
    <div class="tab-content" id="tab-3">
      <div class="section">
        <h2>Generate Test Cookies</h2>
        <p style="color: #666; margin-bottom: 15px;">
          Create realistic test cookie datasets for development and testing.
        </p>

        <div class="controls">
          <div class="input-group">
            <label>Domain:</label>
            <input type="text" id="gen-domain" value="example.com" placeholder="example.com">
          </div>
          <div class="input-group">
            <label>Cookie Count:</label>
            <input type="number" id="gen-count" value="10" min="1" max="100">
          </div>
          <div class="input-group">
            <label>Scenario:</label>
            <select id="gen-scenario">
              <option value="mixed">Mixed (tracking + auth + functional)</option>
              <option value="insecure">Insecure auth cookies</option>
              <option value="tracking">Heavy tracking</option>
              <option value="secure">Well-secured</option>
            </select>
          </div>
        </div>

        <button class="btn btn-primary" onclick="generateTestCookies()">Generate Cookies</button>
        <button class="btn btn-success" onclick="downloadGenerated()">Download JSON</button>

        <div id="generated-output"></div>
      </div>

      <div class="section">
        <h2>Generate Login Test Pair</h2>
        <p style="color: #666; margin-bottom: 15px;">
          Generate before/after login cookie snapshots for testing login detection.
        </p>

        <div class="controls">
          <div class="input-group">
            <label>Domain:</label>
            <input type="text" id="login-gen-domain" value="example.com">
          </div>
          <div class="input-group">
            <label>New Session Cookies:</label>
            <input type="number" id="login-new-count" value="3" min="1" max="10">
          </div>
        </div>

        <button class="btn btn-primary" onclick="generateLoginPair()">Generate Login Pair</button>

        <div id="login-gen-output"></div>
      </div>
    </div>

    <!-- Tab 4: Backend Testing -->
    <div class="tab-content" id="tab-2">
      <div class="section">
        <h2>Backend API Testing</h2>
        <p style="color: #666; margin-bottom: 15px;">
          Test the Flask backend endpoints to ensure proper integration.
        </p>

        <div class="input-group" style="margin-bottom: 15px;">
          <label>Backend URL:</label>
          <input type="text" id="backend-url" value="http://localhost:5000" placeholder="http://localhost:5000">
        </div>

        <button class="btn btn-primary" onclick="testBackendHealth()">Test /health</button>
        <button class="btn btn-primary" onclick="testBackendDemo()">Test /api/demo</button>
        <button class="btn btn-primary" onclick="testBackendAnalyze()">Test /api/analyze</button>
        <button class="btn btn-primary" onclick="testBackendLogin()">Test /api/analyze-login</button>

        <div id="backend-results"></div>
      </div>

      <div class="section">
        <h2>Custom Analysis Request</h2>
        <p style="color: #666; margin-bottom: 15px;">
          Send custom cookie data to the /api/analyze endpoint.
        </p>

        <textarea id="custom-cookies" placeholder='[{"name": "session", "value": "abc123", "domain": "example.com", ...}]'></textarea>

        <button class="btn btn-primary" onclick="testCustomAnalysis()">Send to Backend</button>

        <div id="custom-results"></div>
      </div>
    </div>
  </div>

  <script>
    let beforeLoginData = null;
    let afterLoginData = null;
    let generatedCookies = null;

    // Tab switching
    function switchTab(index) {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
      });
      document.querySelectorAll('.tab-content').forEach((content, i) => {
        content.classList.toggle('active', i === index);
      });
    }

    // Export Testing
    document.getElementById('export-file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        displayExportResults(data);
      } catch (error) {
        document.getElementById('export-results').innerHTML = `
          <div class="result-box error-box">
            <strong>Error:</strong> ${error.message}
          </div>
        `;
      }
    });

    function displayExportResults(data) {
      const cookies = data.cookies || [];
      
      // Validate format
      const requiredFields = ['exported_at', 'domain', 'total_cookies', 'cookies'];
      const missingFields = requiredFields.filter(f => !(f in data));
      
      let html = '';

      if (missingFields.length > 0) {
        html += `<div class="result-box warning-box">
          <strong>Warning:</strong> Missing fields: ${missingFields.join(', ')}
        </div>`;
      } else {
        html += `<div class="result-box success-box">
          <strong>‚úì Valid Export Format</strong>
        </div>`;
      }

      // Display statistics
      html += `
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">Total Cookies</div>
            <div class="stat-value">${cookies.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Domain</div>
            <div class="stat-value" style="font-size: 14px;">${data.domain || 'N/A'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Exported</div>
            <div class="stat-value" style="font-size: 12px;">${new Date(data.exported_at).toLocaleString()}</div>
          </div>
        </div>
      `;

      // Cookie type breakdown
      const types = {};
      const security = { secure: 0, httpOnly: 0, sameSite: 0 };
      
      cookies.forEach(c => {
        const type = c.type || 'unknown';
        types[type] = (types[type] || 0) + 1;
        if (c.secure) security.secure++;
        if (c.httpOnly) security.httpOnly++;
        if (c.sameSite && c.sameSite !== 'none') security.sameSite++;
      });

      html += `
        <h3>Cookie Types</h3>
        <div class="stat-grid">
          ${Object.entries(types).map(([type, count]) => `
            <div class="stat-card">
              <div class="stat-label">${type}</div>
              <div class="stat-value">${count}</div>
            </div>
          `).join('')}
        </div>

        <h3>Security Flags</h3>
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">Secure</div>
            <div class="stat-value">${security.secure}/${cookies.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">HttpOnly</div>
            <div class="stat-value">${security.httpOnly}/${cookies.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">SameSite</div>
            <div class="stat-value">${security.sameSite}/${cookies.length}</div>
          </div>
        </div>

        <h3>Cookie Details</h3>
        <table class="cookie-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Domain</th>
              <th>Secure</th>
              <th>HttpOnly</th>
              <th>SameSite</th>
            </tr>
          </thead>
          <tbody>
            ${cookies.slice(0, 20).map(c => `
              <tr>
                <td><strong>${c.name}</strong></td>
                <td><span class="badge badge-low">${c.type || 'unknown'}</span></td>
                <td>${c.domain}</td>
                <td>${c.secure ? '‚úì' : '‚úó'}</td>
                <td>${c.httpOnly ? '‚úì' : '‚úó'}</td>
                <td>${c.sameSite || 'none'}</td>
              </tr>
            `).join('')}
            ${cookies.length > 20 ? `<tr><td colspan="6" style="text-align: center; color: #666;">... and ${cookies.length - 20} more</td></tr>` : ''}
          </tbody>
        </table>
      `;

      document.getElementById('export-results').innerHTML = html;
    }

    // Login Model Testing
    document.getElementById('before-file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const text = await file.text();
      beforeLoginData = JSON.parse(text);
      
      document.getElementById('login-results').innerHTML = `
        <div class="result-box success-box">
          ‚úì Loaded ${beforeLoginData.cookies.length} cookies from BEFORE snapshot
        </div>
      `;
    });

    document.getElementById('after-file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const text = await file.text();
      afterLoginData = JSON.parse(text);
      
      const existing = document.getElementById('login-results').innerHTML;
      document.getElementById('login-results').innerHTML = existing + `
        <div class="result-box success-box">
          ‚úì Loaded ${afterLoginData.cookies.length} cookies from AFTER snapshot
        </div>
      `;
    });

    function analyzeLoginDiff() {
      if (!beforeLoginData || !afterLoginData) {
        alert('Please upload both before and after cookie files');
        return;
      }

      const before = beforeLoginData.cookies;
      const after = afterLoginData.cookies;

      // Create maps for comparison
      const beforeMap = new Map(before.map(c => [c.name, c]));
      const afterMap = new Map(after.map(c => [c.name, c]));

      const added = [];
      const removed = [];
      const modified = [];

      // Find added and modified
      for (const [name, cookie] of afterMap) {
        if (!beforeMap.has(name)) {
          added.push(cookie);
        } else {
          const beforeCookie = beforeMap.get(name);
          if (JSON.stringify(beforeCookie) !== JSON.stringify(cookie)) {
            modified.push({ before: beforeCookie, after: cookie });
          }
        }
      }

      // Find removed
      for (const [name, cookie] of beforeMap) {
        if (!afterMap.has(name)) {
          removed.push(cookie);
        }
      }

      displayLoginResults(added, removed, modified);
    }

    function displayLoginResults(added, removed, modified) {
      let html = `
        <div class="result-box success-box">
          <strong>‚úì Analysis Complete</strong>
        </div>

        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">Added</div>
            <div class="stat-value" style="color: #28a745;">${added.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Removed</div>
            <div class="stat-value" style="color: #dc3545;">${removed.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Modified</div>
            <div class="stat-value" style="color: #ffc107;">${modified.length}</div>
          </div>
        </div>

        <h3>Login Detection Analysis</h3>
        <div class="result-box">
          ${detectLoginPatterns(added, removed, modified)}
        </div>

        <div class="diff-container">
          <div class="diff-section">
            <h3>Added Cookies (${added.length})</h3>
            ${added.map(c => `
              <div class="cookie-item added">
                <strong>${c.name}</strong>
                <div style="font-size: 11px; color: #666; margin-top: 4px;">
                  ${c.domain} ‚Ä¢ ${c.type || 'unknown'}
                </div>
              </div>
            `).join('')}
          </div>

          <div class="diff-section">
            <h3>Removed Cookies (${removed.length})</h3>
            ${removed.map(c => `
              <div class="cookie-item removed">
                <strong>${c.name}</strong>
                <div style="font-size: 11px; color: #666; margin-top: 4px;">
                  ${c.domain} ‚Ä¢ ${c.type || 'unknown'}
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        ${modified.length > 0 ? `
          <h3>Modified Cookies (${modified.length})</h3>
          ${modified.map((m, i) => `
            <div class="cookie-item modified">
              <strong>${m.after.name}</strong>
              <button class="collapse-btn" onclick="toggleModified(${i})">Show changes ‚ñº</button>
              <div id="modified-${i}" class="collapsible-content hidden">
                <div style="font-size: 11px;">
                  <strong>Before:</strong><br>
                  Value: ${m.before.value?.substring(0, 40)}...<br>
                  Secure: ${m.before.secure}, HttpOnly: ${m.before.httpOnly}, SameSite: ${m.before.sameSite || 'none'}<br>
                  <strong>After:</strong><br>
                  Value: ${m.after.value?.substring(0, 40)}...<br>
                  Secure: ${m.after.secure}, HttpOnly: ${m.after.httpOnly}, SameSite: ${m.after.sameSite || 'none'}
                </div>
              </div>
            </div>
          `).join('')}
        ` : ''}
      `;

      document.getElementById('login-results').innerHTML = html;
    }

    function detectLoginPatterns(added, removed, modified) {
      const patterns = [];

      // Pattern 1: Session cookies added
      const sessionCookies = added.filter(c => 
        c.name.toLowerCase().includes('session') || 
        c.name.toLowerCase().includes('sess') ||
        c.name.toLowerCase().includes('token') ||
        c.name.toLowerCase().includes('auth')
      );

      if (sessionCookies.length > 0) {
        patterns.push(`‚úì <strong>Login Detected:</strong> ${sessionCookies.length} session/auth cookie(s) added`);
      }

      // Pattern 2: Temporary cookies removed
      const tempRemoved = removed.filter(c => 
        c.name.toLowerCase().includes('temp') ||
        c.name.toLowerCase().includes('csrf') ||
        c.name.toLowerCase().includes('nonce')
      );

      if (tempRemoved.length > 0) {
        patterns.push(`‚úì <strong>Cleanup Detected:</strong> ${tempRemoved.length} temporary cookie(s) removed`);
      }

      // Pattern 3: Cookie value changes
      if (modified.length > 0) {
        patterns.push(`‚úì <strong>Session Update:</strong> ${modified.length} cookie(s) modified`);
      }

      // Pattern 4: Overall assessment
      if (added.length > removed.length && sessionCookies.length > 0) {
        patterns.push(`<br><strong>Verdict:</strong> <span style="color: #28a745;">High confidence login event detected</span>`);
      } else if (added.length === 0 && removed.length > 0) {
        patterns.push(`<br><strong>Verdict:</strong> <span style="color: #dc3545;">Possible logout event</span>`);
      } else if (added.length === 0 && removed.length === 0 && modified.length > 0) {
        patterns.push(`<br><strong>Verdict:</strong> <span style="color: #ffc107;">Session refresh or update</span>`);
      }

      return patterns.length > 0 ? patterns.join('<br>') : 'No clear login/logout pattern detected';
    }

    function toggleModified(index) {
      const element = document.getElementById(`modified-${index}`);
      element.classList.toggle('hidden');
    }

    function clearLoginTest() {
      beforeLoginData = null;
      afterLoginData = null;
      document.getElementById('login-results').innerHTML = '';
    }

    // Generate Test Cookies
    function generateTestCookies() {
      const domain = document.getElementById('gen-domain').value;
      const count = parseInt(document.getElementById('gen-count').value);
      const scenario = document.getElementById('gen-scenario').value;

      const cookies = [];
      const cookieNames = {
        auth: ['session_id', 'auth_token', 'user_id', 'login_token', 'csrf_token'],
        tracking: ['_ga', '_gid', '__utma', '__utmz', 'analytics_id', 'visitor_id'],
        functional: ['preferences', 'language', 'theme', 'cart_id', 'currency']
      };

      for (let i = 0; i < count; i++) {
        let type, name, secure, httpOnly, sameSite;

        if (scenario === 'insecure') {
          type = 'authentication';
          name = cookieNames.auth[i % cookieNames.auth.length] + '_' + i;
          secure = false;
          httpOnly = false;
          sameSite = 'none';
        } else if (scenario === 'tracking') {
          type = 'tracking';
          name = cookieNames.tracking[i % cookieNames.tracking.length] + '_' + i;
          secure = Math.random() > 0.5;
          httpOnly = false;
          sameSite = 'none';
        } else if (scenario === 'secure') {
          type = i < count / 2 ? 'authentication' : 'functional';
          name = (type === 'authentication' ? cookieNames.auth : cookieNames.functional)[i % 5] + '_' + i;
          secure = true;
          httpOnly = type === 'authentication';
          sameSite = 'strict';
        } else { // mixed
          const types = ['authentication', 'tracking', 'functional'];
          type = types[i % types.length];
          const names = type === 'authentication' ? cookieNames.auth : 
                       type === 'tracking' ? cookieNames.tracking : cookieNames.functional;
          name = names[i % names.length] + '_' + i;
          secure = Math.random() > 0.3;
          httpOnly = type === 'authentication' && Math.random() > 0.3;
          sameSite = ['none', 'lax', 'strict'][Math.floor(Math.random() * 3)];
        }

        cookies.push({
          name: name,
          value: generateRandomValue(),
          domain: domain,
          path: '/',
          secure: secure,
          httpOnly: httpOnly,
          sameSite: sameSite,
          type: type,
          expirationDate: Math.floor(Date.now() / 1000) + (86400 * (Math.random() * 365))
        });
      }

      generatedCookies = {
        exported_at: new Date().toISOString(),
        domain: domain,
        total_cookies: cookies.length,
        cookies: cookies
      };

      document.getElementById('generated-output').innerHTML = `
        <div class="result-box success-box">
          ‚úì Generated ${cookies.length} cookies
        </div>
        <div class="code-block">${JSON.stringify(generatedCookies, null, 2).substring(0, 1000)}...</div>
      `;
    }

    function generateRandomValue() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }

    function downloadGenerated() {
      if (!generatedCookies) {
        alert('Generate cookies first');
        return;
      }

      const blob = new Blob([JSON.stringify(generatedCookies, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `test-cookies-${Date.now()}.json`;
      a.click();
    }

    function generateLoginPair() {
      const domain = document.getElementById('login-gen-domain').value;
      const newCount = parseInt(document.getElementById('login-new-count').value);

      // Before login: some tracking + functional cookies
      const beforeCookies = [
        { name: '_ga', value: generateRandomValue(), domain, type: 'tracking', secure: true, httpOnly: false, sameSite: 'lax' },
        { name: 'preferences', value: 'dark', domain, type: 'functional', secure: false, httpOnly: false, sameSite: 'lax' },
        { name: 'csrf_temp', value: generateRandomValue(), domain, type: 'functional', secure: true, httpOnly: true, sameSite: 'strict' }
      ];

      // After login: keep some, add session cookies, remove temp
      const afterCookies = [
        beforeCookies[0], // Keep _ga
        beforeCookies[1], // Keep preferences
        // Remove csrf_temp
        // Add new session cookies
        ...Array.from({ length: newCount }, (_, i) => ({
          name: ['session_id', 'auth_token', 'user_id'][i % 3] + (i > 2 ? '_' + i : ''),
          value: generateRandomValue(),
          domain,
          type: 'authentication',
          secure: true,
          httpOnly: true,
          sameSite: 'strict',
          expirationDate: Math.floor(Date.now() / 1000) + 86400
        }))
      ];

      const beforeData = {
        exported_at: new Date(Date.now() - 60000).toISOString(),
        domain,
        total_cookies: beforeCookies.length,
        cookies: beforeCookies
      };

      const afterData = {
        exported_at: new Date().toISOString(),
        domain,
        total_cookies: afterCookies.length,
        cookies: afterCookies
      };

      // Auto-download both files
      downloadJSON(beforeData, `before-login-${domain}.json`);
      setTimeout(() => downloadJSON(afterData, `after-login-${domain}.json`), 500);

      document.getElementById('login-gen-output').innerHTML = `
        <div class="result-box success-box">
          ‚úì Generated login test pair<br>
          ‚Ä¢ Before: ${beforeCookies.length} cookies<br>
          ‚Ä¢ After: ${afterCookies.length} cookies<br>
          ‚Ä¢ Files downloaded automatically
        </div>
      `;
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }

    // Backend Testing
    async function testBackendHealth() {
      const url = document.getElementById('backend-url').value;
      const resultsDiv = document.getElementById('backend-results');
      
      resultsDiv.innerHTML = '<div class="result-box">Testing...</div>';

      try {
        const response = await fetch(`${url}/health`);
        const data = await response.json();
        
        resultsDiv.innerHTML = `
          <div class="result-box success-box">
            <strong>‚úì /health endpoint working</strong><br>
            Status: ${data.status}<br>
            Model loaded: ${data.model_loaded}
          </div>
          <div class="code-block">${JSON.stringify(data, null, 2)}</div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="result-box error-box">
            <strong>‚úó Connection failed</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    async function testBackendDemo() {
      const url = document.getElementById('backend-url').value;
      const resultsDiv = document.getElementById('backend-results');
      
      resultsDiv.innerHTML = '<div class="result-box">Testing...</div>';

      try {
        const response = await fetch(`${url}/api/demo`);
        const data = await response.json();
        
        resultsDiv.innerHTML = `
          <div class="result-box success-box">
            <strong>‚úì /api/demo endpoint working</strong><br>
            Cookies: ${data.cookies?.length || 0}
          </div>
          <div class="code-block">${JSON.stringify(data, null, 2).substring(0, 1000)}...</div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="result-box error-box">
            <strong>‚úó Request failed</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    async function testBackendAnalyze() {
      const url = document.getElementById('backend-url').value;
      const resultsDiv = document.getElementById('backend-results');
      
      resultsDiv.innerHTML = '<div class="result-box">Testing...</div>';

      // Create test cookies
      const testCookies = [
        {
          name: 'session_id',
          value: 'abc123',
          domain: 'example.com',
          secure: false,
          httpOnly: false,
          sameSite: 'none',
          type: 'authentication'
        }
      ];

      try {
        const response = await fetch(`${url}/api/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookies: testCookies })
        });
        const data = await response.json();
        
        resultsDiv.innerHTML = `
          <div class="result-box success-box">
            <strong>‚úì /api/analyze endpoint working</strong><br>
            Results: ${data.results?.length || 0}
          </div>
          <div class="code-block">${JSON.stringify(data, null, 2)}</div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="result-box error-box">
            <strong>‚úó Request failed</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    async function testBackendLogin() {
      const url = document.getElementById('backend-url').value;
      const resultsDiv = document.getElementById('backend-results');
      
      resultsDiv.innerHTML = '<div class="result-box">Testing...</div>';

      const beforeCookies = [
        { name: '_ga', value: 'GA1.2.123', domain: 'example.com', type: 'tracking' }
      ];

      const afterCookies = [
        { name: '_ga', value: 'GA1.2.123', domain: 'example.com', type: 'tracking' },
        { name: 'session_id', value: 'xyz789', domain: 'example.com', type: 'authentication', secure: true, httpOnly: true }
      ];

      try {
        const response = await fetch(`${url}/api/analyze-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ before: beforeCookies, after: afterCookies })
        });
        const data = await response.json();
        
        resultsDiv.innerHTML = `
          <div class="result-box success-box">
            <strong>‚úì /api/analyze-login endpoint working</strong><br>
            Login detected: ${data.login_detected}
          </div>
          <div class="code-block">${JSON.stringify(data, null, 2)}</div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="result-box error-box">
            <strong>‚úó Request failed</strong><br>
            ${error.message}
          </div>
        `;
      }
    }

    async function testCustomAnalysis() {
      const url = document.getElementById('backend-url').value;
      const cookiesText = document.getElementById('custom-cookies').value;
      const resultsDiv = document.getElementById('custom-results');

      if (!cookiesText.trim()) {
        alert('Please enter cookie data');
        return;
      }

      try {
        const cookies = JSON.parse(cookiesText);
        resultsDiv.innerHTML = '<div class="result-box">Analyzing...</div>';

        const response = await fetch(`${url}/api/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookies })
        });
        const data = await response.json();

        resultsDiv.innerHTML = `
          <div class="result-box success-box">
            <strong>‚úì Analysis complete</strong>
          </div>
          <div class="code-block">${JSON.stringify(data, null, 2)}</div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="result-box error-box">
            <strong>‚úó Error:</strong> ${error.message}
          </div>
        `;
      }
    }
  </script>
</body>
</html>
